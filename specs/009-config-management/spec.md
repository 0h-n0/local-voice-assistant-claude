# Feature Specification: 設定管理機能

**Feature Branch**: `009-config-management`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "APIキー、モデルパス、音声デバイスなどを設定ファイルまたは .env で管理できるようにしたい。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 環境変数による設定管理 (Priority: P1)

開発者として、APIキーやサービスURLなどの機密性の高い設定を `.env` ファイルで管理したい。これにより、設定をソースコードから分離し、環境ごとに異なる値を安全に管理できる。

**Why this priority**: 機密情報（APIキー等）をソースコードにハードコードすることはセキュリティリスクとなるため、最優先で対応が必要。

**Independent Test**: `.env` ファイルを作成し、アプリケーションを起動して設定値が正しく読み込まれることを確認する。

**Acceptance Scenarios**:

1. **Given** `.env` ファイルに `OPENAI_API_KEY=sk-xxx` が設定されている, **When** アプリケーションを起動する, **Then** LLMサービスがそのAPIキーを使用して動作する
2. **Given** `.env` ファイルが存在しない, **When** アプリケーションを起動する, **Then** デフォルト値または明確なエラーメッセージが表示される
3. **Given** `.env` ファイルに無効な値が設定されている, **When** アプリケーションを起動する, **Then** バリデーションエラーが表示され、起動が停止する

---

### User Story 2 - モデルパスの設定 (Priority: P1)

開発者として、音声認識モデルや音声合成モデルのファイルパスを設定ファイルで管理したい。これにより、モデルを更新したり、異なるモデルを使い分けたりできる。

**Why this priority**: モデルパスがハードコードされていると、モデルの更新や環境間での移行が困難になるため。

**Independent Test**: 設定ファイルでモデルパスを変更し、アプリケーションが指定されたモデルを読み込むことを確認する。

**Acceptance Scenarios**:

1. **Given** 設定で `STT_MODEL_PATH=/models/stt/v2` が指定されている, **When** 音声認識を実行する, **Then** 指定されたパスのモデルが使用される
2. **Given** 設定で指定されたモデルパスが存在しない, **When** アプリケーションを起動する, **Then** モデルが見つからない旨のエラーメッセージが表示される

---

### User Story 3 - サービスURL設定 (Priority: P2)

開発者として、外部サービス（STT、TTS、LLM）のエンドポイントURLを設定で管理したい。これにより、ローカル開発とデプロイ環境で異なるサービスを使い分けられる。

**Why this priority**: 開発・テスト・本番で異なるサービスエンドポイントを使うことが一般的であり、柔軟な切り替えが必要。

**Independent Test**: 設定でサービスURLを変更し、アプリケーションが正しいエンドポイントに接続することを確認する。

**Acceptance Scenarios**:

1. **Given** 設定で `STT_SERVICE_URL=http://localhost:8001` が指定されている, **When** 音声認識APIを呼び出す, **Then** 指定されたURLにリクエストが送信される
2. **Given** 設定で無効なURLが指定されている, **When** アプリケーションを起動する, **Then** URL形式のバリデーションエラーが表示される

---

### User Story 4 - 設定の一覧表示 (Priority: P3)

開発者として、現在の設定値を確認できるAPIまたはコマンドが欲しい。これにより、デバッグや設定確認が容易になる。

**Why this priority**: 設定の確認はデバッグに役立つが、基本的な設定管理が動作してから実装すればよい。

**Independent Test**: 設定確認APIを呼び出し、現在の設定値（機密情報はマスク）が表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** アプリケーションが起動している, **When** 設定確認APIを呼び出す, **Then** 現在の設定値一覧が返される
2. **Given** アプリケーションが起動している, **When** 設定確認APIを呼び出す, **Then** APIキーなどの機密情報はマスクされて表示される

---

### Edge Cases

- 環境変数と設定ファイルの両方に同じ設定がある場合、どちらが優先されるか？（環境変数を優先）
- 設定ファイルの形式が不正な場合、どうなるか？（パースエラーを表示して起動停止）
- 必須設定が欠けている場合、どうなるか？（明確なエラーメッセージを表示）
- 設定値の型が不正な場合（数値に文字列など）、どうなるか？（バリデーションエラーを表示）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは `.env` ファイルから環境変数を読み込めること
- **FR-002**: システムは環境変数が設定ファイルより優先されること
- **FR-003**: システムは以下のカテゴリの設定を管理できること：
  - APIキー（OpenAI、Deepgram等）
  - モデルファイルパス（STT、TTS）
  - サービスURL（内部サービスのエンドポイント）
  - アプリケーション設定（ポート番号、ログレベル等）
- **FR-004**: システムは設定値のバリデーションを起動時に実行すること
- **FR-005**: システムは必須設定が欠けている場合、明確なエラーメッセージを表示すること
- **FR-006**: システムは設定確認APIで現在の設定を表示できること（機密情報はマスク）
- **FR-007**: システムはサンプル設定ファイル（`.env.example`）を提供すること

### Key Entities

- **ConfigurationItem**: 設定項目（名前、値、型、必須フラグ、機密フラグ、デフォルト値、説明）
- **ConfigurationCategory**: 設定カテゴリ（API Keys、Model Paths、Service URLs、Application Settings）
- **ValidationResult**: バリデーション結果（成功/失敗、エラーメッセージ）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: すべての環境固有設定がソースコード外（`.env`または環境変数）で管理されていること
- **SC-002**: 設定ミスによる起動失敗時、エラーメッセージから問題の特定に1分以内で到達できること
- **SC-003**: 新しい開発者が `.env.example` をコピーして必要な値を埋めるだけで環境構築できること
- **SC-004**: 機密情報（APIキー等）がログやAPIレスポンスに露出しないこと

## Assumptions

- Python環境では `python-dotenv` または同等のライブラリを使用する（標準的なアプローチ）
- フロントエンドの設定は Next.js の標準的な環境変数機能（`NEXT_PUBLIC_*`）を使用する
- 設定ファイルの形式は `.env`（key=value形式）を採用する（YAML/JSONより単純で広くサポートされている）
- 本番環境では `.env` ファイルではなく、コンテナの環境変数やシークレット管理サービスを使用することを想定

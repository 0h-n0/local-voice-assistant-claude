# Feature Specification: Conversation History Storage

**Feature Branch**: `006-conversation-storage`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "ユーザーとアシスタントの会話履歴を保存・取得できるストレージ機能を実装したい。SQLiteを想定。"

## Clarifications

### Session 2025-12-26

- Q: 既存の音声対話オーケストレーターとの統合方法は？ → A: オーケストレーターが自動的に履歴を保存する（内部呼び出し）
- Q: 会話IDの生成・管理方法は？ → A: オーケストレーターが生成した会話IDを履歴サービスに渡す
- Q: 会話履歴の取得・削除機能へのアクセス方法は？ → A: REST APIエンドポイントを提供する

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Save Conversation Message (Priority: P1)

ユーザーが音声対話を行った際、そのやり取り（ユーザーの発話テキストとアシスタントの応答テキスト）が自動的に保存される。これにより、会話の履歴を後から参照できるようになる。

**Why this priority**: 会話履歴の保存は本機能の核心であり、これがなければ他の機能（履歴取得、削除など）が成り立たない。

**Independent Test**: 音声対話APIを1回実行し、その後データベースに会話レコードが存在することを確認できる。

**Acceptance Scenarios**:

1. **Given** 会話が開始されている状態, **When** ユーザーが発話しアシスタントが応答する, **Then** ユーザーの発話テキスト、アシスタントの応答テキスト、タイムスタンプが保存される
2. **Given** 同じ会話セッション内, **When** 複数回のやり取りが行われる, **Then** 各やり取りが順序を保持して保存される
3. **Given** 新しい会話セッション, **When** 会話が開始される, **Then** 新しい会話IDが割り当てられ、メッセージが関連付けられる

---

### User Story 2 - Retrieve Conversation History (Priority: P1)

ユーザーまたはシステムが過去の会話履歴を取得できる。会話ID指定で特定の会話を取得したり、一覧で最近の会話を確認できる。

**Why this priority**: 保存された履歴を取得できなければ、保存機能の価値がない。保存と取得は本機能の両輪である。

**Independent Test**: 保存済みの会話IDを指定して、その会話の全メッセージを時系列順で取得できることを確認。

**Acceptance Scenarios**:

1. **Given** 会話履歴が保存されている状態, **When** 会話IDで履歴を取得する, **Then** その会話のすべてのメッセージが時系列順で返される
2. **Given** 複数の会話が保存されている状態, **When** 会話一覧を取得する, **Then** 最新の会話から順にリストが返される
3. **Given** 存在しない会話IDで取得を試みる, **When** 履歴取得を実行, **Then** 適切なエラー（会話が見つからない）が返される

---

### User Story 3 - Delete Conversation (Priority: P2)

ユーザーが不要になった会話履歴を削除できる。プライバシー保護やストレージ管理のために必要。

**Why this priority**: 基本的な保存・取得機能が優先されるが、プライバシー観点から削除機能も重要。

**Independent Test**: 保存済みの会話を削除し、その後取得を試みて見つからないことを確認。

**Acceptance Scenarios**:

1. **Given** 会話履歴が存在する状態, **When** 会話IDを指定して削除を実行, **Then** その会話とすべての関連メッセージが削除される
2. **Given** 存在しない会話IDで削除を試みる, **When** 削除を実行, **Then** 適切なエラー（会話が見つからない）が返される

---

### Edge Cases

- 非常に長いメッセージ（数千文字）が保存される場合は？
  - 文字数制限を設け、制限を超える場合はエラーを返す
- 同時に複数のリクエストが同じ会話に書き込む場合は？
  - データベースレベルでの整合性を保証し、順序は受信順とする
- データベースファイルが破損した場合は？
  - 適切なエラーハンドリングを行い、サービスは継続可能な状態を維持する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは会話セッションを一意に識別できる会話IDを生成・管理できること
- **FR-002**: システムはメッセージ（発話者ロール、テキスト内容、タイムスタンプ）を保存できること
- **FR-003**: システムは会話IDに紐づくすべてのメッセージを時系列順で取得できること
- **FR-004**: システムは保存されている会話の一覧を取得できること（ページネーション対応）
- **FR-005**: システムは指定された会話とその関連メッセージを削除できること
- **FR-006**: システムはメッセージのテキストを最大10,000文字まで保存できること
- **FR-007**: システムは会話にメタデータ（作成日時、最終更新日時）を記録すること
- **FR-008**: システムはデータベース接続エラー時に適切なエラーを返すこと

### Key Entities

- **Conversation（会話）**: 一連のやり取りをまとめる単位。会話ID、作成日時、最終更新日時を持つ。
- **Message（メッセージ）**: 会話内の1つの発言。会話への参照、ロール（user/assistant）、テキスト内容、タイムスタンプを持つ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: メッセージの保存処理は100ミリ秒以内に完了すること
- **SC-002**: 100件のメッセージを含む会話履歴の取得が500ミリ秒以内に完了すること
- **SC-003**: 会話一覧の取得（最新20件）が200ミリ秒以内に完了すること
- **SC-004**: 1,000会話・10,000メッセージの規模でも性能劣化なく動作すること
- **SC-005**: データベースエラー発生時も他のAPIエンドポイントは正常に動作を継続すること

## Integration

- **Orchestrator Integration**: 音声対話オーケストレーター（005-voice-orchestrator）が会話履歴サービスを内部的に呼び出し、対話完了時に自動的にメッセージを保存する。外部からの明示的な保存APIは提供しない。
- **Conversation ID Management**: 会話IDはオーケストレーターが生成し、履歴サービスに渡す。履歴サービスは渡されたIDを使用して会話を識別・管理する。
- **History Access API**: 会話履歴の取得・削除機能はREST APIエンドポイントとして提供する（GET /api/conversations, GET /api/conversations/{id}, DELETE /api/conversations/{id}）。

## Assumptions

- 本機能はローカル環境での使用を想定し、マルチユーザー認証は不要
- 会話履歴のデータ保持期間に制限は設けない（ユーザーが明示的に削除するまで保持）
- 音声データ自体は保存せず、テキスト変換後のテキストのみを保存
- SQLiteを使用し、データベースファイルはローカルファイルシステムに配置

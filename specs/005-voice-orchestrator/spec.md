# Feature Specification: Voice Dialogue Orchestrator

**Feature Branch**: `005-voice-orchestrator`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "STT → LLM → TTS を順番に実行し、1つの音声対話を完結させるオーケストレーターを実装したい。"

## Overview

音声入力から音声応答までの一連の処理を統合するオーケストレーターを実装する。ユーザーが音声で質問すると、システムがその音声を認識し（STT）、適切な応答を生成し（LLM）、その応答を音声で返す（TTS）という一連のフローを単一のAPIエンドポイントで実現する。

## Clarifications

### Session 2025-12-26

- Q: レスポンス形式（音声とメタデータの返却方法）は？ → A: 音声ファイル（WAV）のみ返却、メタデータはHTTPヘッダーに含める

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 音声による質問と音声応答 (Priority: P1)

ユーザーが音声ファイルをシステムに送信すると、システムがその内容を理解し、適切な応答を音声ファイルとして返却する。

**Why this priority**: これがオーケストレーターの核心機能であり、MVP（最小実行可能製品）として単独で価値を提供できる。

**Independent Test**: 音声ファイル（例: 「今日の天気は？」）をAPIに送信し、音声ファイル（WAV形式）で応答を受け取れることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが日本語の音声ファイルを持っている, **When** その音声ファイルをオーケストレーターAPIに送信する, **Then** 日本語の音声応答ファイル（WAV形式）を受け取る
2. **Given** 音声ファイルに明確な質問が含まれている, **When** APIを呼び出す, **Then** 質問に対する適切な応答が音声として返される
3. **Given** システムが正常に稼働している, **When** 音声ファイルを送信する, **Then** 30秒以内に応答が返される

---

### User Story 2 - 処理ステータスの確認 (Priority: P2)

開発者・運用者がオーケストレーターの状態（各サービスの接続状態、処理可能かどうか）を確認できる。

**Why this priority**: 運用監視のために必要であり、問題発生時のトラブルシューティングに不可欠。

**Independent Test**: ステータスAPIを呼び出し、STT/LLM/TTSの各サービスの状態がJSON形式で返されることを確認する。

**Acceptance Scenarios**:

1. **Given** 全てのサービスが正常に稼働している, **When** ステータスAPIを呼び出す, **Then** 各サービスの状態が "healthy" として返される
2. **Given** いずれかのサービスが利用不可の状態である, **When** ステータスAPIを呼び出す, **Then** 該当サービスの状態が "unhealthy" として返され、問題の詳細が含まれる

---

### User Story 3 - エラー時の適切な応答 (Priority: P3)

処理中にエラーが発生した場合、ユーザーにわかりやすいエラーメッセージを返す。

**Why this priority**: 堅牢性のために必要だが、正常系の機能が優先。

**Independent Test**: 無効な音声ファイルや空のリクエストを送信し、適切なエラーレスポンスが返されることを確認する。

**Acceptance Scenarios**:

1. **Given** 無効な形式のファイルが送信される, **When** APIを呼び出す, **Then** 400 Bad Request と具体的なエラーメッセージが返される
2. **Given** 音声認識に失敗する（無音・ノイズのみ）, **When** APIを呼び出す, **Then** 認識失敗を示すエラーとリトライの提案が返される
3. **Given** 内部サービスがタイムアウトする, **When** APIを呼び出す, **Then** 503 Service Unavailable と復旧の見込みが返される

---

### Edge Cases

- 音声ファイルが極端に短い（0.5秒未満）場合はどうなるか？→ 認識不可として適切なエラーを返す
- 音声ファイルが極端に長い（5分以上）場合はどうなるか？→ 制限を超過したエラーを返す
- 同時に多数のリクエストが来た場合はどうなるか？→ 同時処理数の制限を設け、超過時は429 Too Many Requestsを返す
- STTで認識されたテキストが空の場合はどうなるか？→ 「音声を認識できませんでした」とエラーを返す

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは音声ファイル（WAV, MP3, M4A, WebM形式）を受け取り、処理できなければならない
- **FR-002**: システムは受け取った音声をSTTサービスでテキストに変換しなければならない
- **FR-003**: システムは変換されたテキストをLLMサービスに送信し、応答テキストを取得しなければならない
- **FR-004**: システムはLLMからの応答テキストをTTSサービスで音声に変換しなければならない
- **FR-005**: システムは生成された音声をWAV形式でユーザーに返却しなければならない
- **FR-006**: システムは音声ファイル（WAV）のみをレスポンスボディとして返却し、処理メタデータ（各ステップの処理時間、認識テキスト長、生成音声長）はHTTPヘッダーに含めなければならない
- **FR-007**: システムはオーケストレーター全体の健全性ステータスを提供しなければならない
- **FR-008**: システムは同時リクエスト数を制御し、過負荷を防止しなければならない
- **FR-009**: システムはいずれかのステップでエラーが発生した場合、適切なエラーコードとメッセージを返却しなければならない
- **FR-010**: システムは音声入力の最大長を制限しなければならない（デフォルト: 5分）

### Key Entities

- **VoiceDialogueRequest**: 音声対話リクエスト。音声ファイルデータ、オプションのパラメータ（話速など）を含む
- **VoiceDialogueResponse**: 音声対話レスポンス。音声ファイルデータ（WAV）、処理メタデータを含む
- **PipelineStatus**: パイプラインの状態。STT/LLM/TTSの各サービス状態を集約
- **ProcessingMetadata**: 処理メタデータ。各ステップの処理時間、テキスト長、音声長などの情報

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは音声質問を送信してから30秒以内に音声応答を受け取ることができる（10秒以内の音声入力の場合）
- **SC-002**: システムは5件の同時リクエストを処理できる
- **SC-003**: 正常な音声入力に対して95%以上の成功率で応答を返す
- **SC-004**: ステータスAPIは500ミリ秒以内に応答を返す
- **SC-005**: エラー発生時、ユーザーは問題の原因を理解できるエラーメッセージを受け取る

## Assumptions

- STT API (`/api/stt/transcribe`)、LLM API (`/api/llm/generate`)、TTS API (`/api/tts/synthesize`) が既に実装されており、利用可能である
- 各サービスは独立して動作し、オーケストレーターは順次呼び出す
- 音声入力は日本語のみを対象とする
- LLMへのシステムプロンプトはオーケストレーター側で設定する（音声アシスタント用のプロンプト）
- 会話履歴の管理は本機能のスコープ外とする（単一ターンの対話のみ）

## Out of Scope

- マルチターン会話（会話履歴の保持と文脈理解）
- ストリーミング応答（音声のリアルタイム生成・送信）
- 多言語対応（日本語以外の言語）
- 音声ファイルの永続保存
- ユーザー認証・認可

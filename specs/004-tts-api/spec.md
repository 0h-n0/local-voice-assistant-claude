# Feature Specification: TTS API (Text-to-Speech)

**Feature Branch**: `004-tts-api`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "Style-Bert-VITS2 を用いて日本語テキストを自然音声に変換する TTS API を実装したい。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - テキストから音声ファイル生成 (Priority: P1)

ユーザーは日本語テキストを送信し、自然な音声ファイルを受け取る。音声アシスタントのレスポンスを音声で出力するための基本機能。

**Why this priority**: 音声アシスタントの核となる機能。LLM サービスからのテキスト応答を音声に変換することで、ユーザーとの自然な対話が可能になる。

**Independent Test**: テキストを POST エンドポイントに送信し、再生可能な音声ファイルが返却されることを確認する。

**Acceptance Scenarios**:

1. **Given** TTS サービスが起動している, **When** ユーザーが「こんにちは」というテキストを送信する, **Then** 「こんにちは」と発話する音声ファイルが返却される
2. **Given** TTS サービスが起動している, **When** ユーザーが長文（500文字）のテキストを送信する, **Then** 全文を読み上げる音声ファイルが返却される
3. **Given** TTS サービスが起動している, **When** ユーザーが空のテキストを送信する, **Then** エラーメッセージが返却される

---

### User Story 2 - 音声パラメータのカスタマイズ (Priority: P2)

ユーザーは音声生成時に話速やピッチなどのパラメータを指定し、好みの音声出力を得る。

**Why this priority**: 基本機能の拡張。ユーザー体験の向上に寄与するが、デフォルト値で基本機能は動作する。

**Independent Test**: パラメータを指定して音声を生成し、指定したパラメータが反映された音声が返却されることを確認する。

**Acceptance Scenarios**:

1. **Given** TTS サービスが起動している, **When** ユーザーが話速を 1.5 倍に指定してテキストを送信する, **Then** 通常より速い音声ファイルが返却される
2. **Given** TTS サービスが起動している, **When** ユーザーがパラメータを指定しない, **Then** デフォルト設定の音声ファイルが返却される

---

### User Story 3 - サービス健全性の確認 (Priority: P3)

管理者はサービスの稼働状況とモデル読み込み状態を確認する。

**Why this priority**: 運用監視のために必要だが、基本機能の動作には影響しない。

**Independent Test**: ヘルスチェックエンドポイントにアクセスし、サービス状態が返却されることを確認する。

**Acceptance Scenarios**:

1. **Given** TTS サービスが正常に起動している, **When** ステータスエンドポイントにアクセスする, **Then** 正常ステータスとモデル情報が返却される
2. **Given** モデルが読み込まれていない, **When** ステータスエンドポイントにアクセスする, **Then** 異常ステータスとエラー情報が返却される

---

### Edge Cases

- テキストが空または空白のみの場合は、適切なエラーを返す
- テキストが極端に長い（5000文字超）場合は、適切なエラーを返す
- 同時に複数のリクエストが来た場合は、順次処理またはエラーを返す
- モデルが読み込まれていない状態でリクエストが来た場合は、サービス利用不可エラーを返す
- 英数字や記号のみのテキストでも処理を試みる（日本語モデルの限界内で）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは日本語テキストを入力として受け付け、音声ファイルを生成しなければならない
- **FR-002**: システムは生成された音声を標準的な音声フォーマット（WAV）で返却しなければならない
- **FR-003**: システムは話速パラメータ（0.5〜2.0）を受け付け、音声生成に反映しなければならない
- **FR-004**: システムはテキストの長さを検証し、制限（5000文字）を超える場合はエラーを返却しなければならない
- **FR-005**: システムはサービス状態とモデル読み込み状況を確認できるエンドポイントを提供しなければならない
- **FR-006**: システムは音声生成の処理時間を追跡し、レスポンスに含めなければならない
- **FR-007**: システムは同時リクエスト数を制限し、過負荷を防止しなければならない

### Key Entities

- **SynthesisRequest**: 音声合成リクエスト。テキスト、話速、その他パラメータを含む
- **SynthesisResponse**: 音声合成レスポンス。音声データ、処理時間、メタデータを含む
- **TTSStatus**: サービス状態。モデル読み込み状況、利用可能なボイス情報を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100文字の日本語テキストの音声生成が 10 秒以内に完了する
- **SC-002**: 生成された音声は人間が聞き取れる品質であり、テキスト内容と一致する
- **SC-003**: サービスは連続した 100 回のリクエストを処理できる
- **SC-004**: エラー発生時は 1 秒以内に適切なエラーメッセージを返却する
- **SC-005**: サービスステータス確認は 500 ミリ秒以内にレスポンスを返す

## Assumptions

- Style-Bert-VITS2 モデルはローカルで利用可能であり、事前にダウンロード・設定されている
- GPU は必須ではないが、CPU での推論は GPU より遅くなる可能性がある
- デフォルトの音声話者（ボイス）は 1 つで十分であり、複数話者の切り替えは将来の拡張とする
- 音声出力フォーマットは WAV を標準とし、他フォーマット（MP3 等）への変換は将来の拡張とする
- 同時リクエスト処理数は 1〜3 程度を想定（リソース制約による）

## Out of Scope

- 複数話者（ボイス）の切り替え機能
- リアルタイムストリーミング音声出力
- 音声フォーマット変換（MP3、OGG 等）
- 感情やスタイルの動的制御
- 音声ファイルのキャッシュ機能
